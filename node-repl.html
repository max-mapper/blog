<!DOCTYPE html> 
<html> 
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="alternate" type="application/rss+xml" title="Max Ogden Blogotronz (RSS 2.0)" href="http://maxogden.com/rss.xml">
  <title>Max Ogden Blogotronz</title> 
  
  <link href="styles/styles.css" media="screen" rel="stylesheet" type="text/css">
  <link href="styles/rainbow.github.css" media="screen" rel="stylesheet" type="text/css">

  <!-- libraries --> 
  <script src="script/jquery-1.6.1.min.js"></script>
  <script src="script/underscore.js"></script>
  <script src="script/d3.min.js"></script>
  <script src="script/voronoi.min.js"></script>
  <script src="script/rainbow.min.js"></script>
  <script src="script/rainbow.generic.js"></script>
  <script src="script/rainbow.javascript.js"></script>
  <script src="script/rainbow.css.js"></script>
  <script src="script/helpers.js"></script>
  
  <script src="script/application.js"></script>

</head>
<body> 
  <div id="container">
    <div class="header">
      <div class="title"><a href="https://github.com/maxogden" rel="me">Max Ogden</a> | Open Web programmer</div>
      <div class="subtitle"></div>
      <!-- THANKS, MICHAEL BOSTOCK! YOU RULE -->
      <div id="voronoi">
      </div>
      <div class="channel"></div>
      <div id="navigation">
        <div class="toggle home">
          <div class="navitem">
            <span rel="emojilock" style="letter-spacing: 3px;">ğŸ“ğŸŒğŸ’©ğŸ‘¼ğŸ’ŠğŸƒğŸ·ğŸƒğŸŠğŸ‘…â›„ï¸ğŸµğŸ”‹ğŸ‘ŠğŸ«ğŸğŸœğŸ‚ğŸ‡ğŸ£ğŸ¾ğŸ‘›ğŸ“šğŸ‘‡ğŸŸğŸğŸ²ğŸ˜­ğŸˆğŸŠğŸ™ğŸœ</span>
          </div>
        </div>
        <div class="toggle home">
          <div class="navitem">
            <a href="index.html">blog</a>
          </div>
        </div>
        <div class="toggle home">
          <div class="navitem">
            <a href="videos.html">media</a>
          </div>
        </div>
        <div class="toggle home">
          <div class="navitem">
            <a href="contact.html">contact</a>
          </div>
        </div>
      </div>
    </div>
    
    <div id="wrapper">
      <div id="browser">
        <div id="documents"><a class="load-document" href="node-distributed-systems.html">
  <div class="document" id="node-distributed-systems">
    <div class="published" data-published="2016-05-06T06:32:56.584Z">May 2016</div>
    <div class="title">Getting Started With Node For Distributed Systems</div>
    <div class="teaser">Where to get started with streams and peer to peer</div>
  </div>
</a>

<a class="load-document" href="iotjs-and-jerryscript.html">
  <div class="document" id="iotjs-and-jerryscript">
    <div class="published" data-published="2015-07-24T06:32:56.584Z">July 2015</div>
    <div class="title">What's the deal with iot.js and JerryScript</div>
    <div class="teaser">Node.js will soon be running on tiny low power chips</div>
  </div>
</a>

<a class="load-document" href="electron-fundamentals.html">
  <div class="document" id="electron-fundamentals">
    <div class="published" data-published="2015-07-23T06:32:56.584Z">July 2015</div>
    <div class="title">Electron Fundamentals</div>
    <div class="teaser">A quick intro to Electron, a desktop application runtime</div>
  </div>
</a>

<a class="load-document" href="hd-live-streaming-cats.html">
  <div class="document" id="hd-live-streaming-cats">
    <div class="published" data-published="2015-05-26T06:32:56.584Z">May 2015</div>
    <div class="title">HD Live Streaming Cats to YouTube with the Raspberry Pi Camera</div>
    <div class="teaser">A how to guide</div>
  </div>
</a>

<a class="load-document" href="interdisciplinary-open-source-events.html">
  <div class="document" id="interdisciplinary-open-source-events">
    <div class="published" data-published="2015-05-10T06:32:56.584Z">May 2015</div>
    <div class="title">Interdisciplinary Open Source Community Conferences</div>
    <div class="teaser">A list of community organized events</div>
  </div>
</a>

<a class="load-document" href="https-wildcard-nginx-setup.html">
  <div class="document" id="https-wildcard-nginx-setup">
    <div class="published" data-published="2015-04-30T06:32:56.584Z">April 2015</div>
    <div class="title">Setting up HTTPS with a wildcard certificate and Nginx</div>
    <div class="teaser">How I set up HTTPS with Nginx</div>
  </div>
</a>

<a class="load-document" href="a-month-of-modules.html">
  <div class="document" id="a-month-of-modules">
    <div class="published" data-published="2015-04-30T03:32:56.584Z">April 2015</div>
    <div class="title">A Month of Modules</div>
    <div class="teaser">Modules Mafintosh and I wrote this month</div>
  </div>
</a>

<a class="load-document" href="tessel-powered-plant-watering-system.html">
  <div class="document" id="tessel-powered-plant-watering-system">
    <div class="published" data-published="2015-02-25T03:32:56.584Z">February 2015</div>
    <div class="title">Tessel Powered Plant Watering System</div>
    <div class="teaser">Make an HTTP accessible water pump</div>
  </div>
</a>

<a class="load-document" href="portland-fiber.html">
  <div class="document" id="portland-fiber">
    <div class="published" data-published="2015-02-01T03:32:56.584Z">January 2015</div>
    <div class="title">Portland Fiber Internet</div>
    <div class="teaser">Review of 1Gb fiber from CenturyLink</div>
  </div>
</a>

<a class="load-document" href="node-repl.html">
  <div class="document active" id="node-repl">
    <div class="published" data-published="2015-01-24T23:04:02.791Z">January 2015</div>
    <div class="title">node-repl</div>
    <div class="teaser">An interactive console for node</div>
  </div>
</a>

<a class="load-document" href="nested-dependencies.html">
  <div class="document" id="nested-dependencies">
    <div class="published" data-published="2015-01-13T22:24:35.821Z">January 2015</div>
    <div class="title">Nested Dependencies</div>
    <div class="teaser">Insight into why node_modules works the way it does</div>
  </div>
</a>

<a class="load-document" href="node-packaged-modules.html">
  <div class="document" id="node-packaged-modules">
    <div class="published" data-published="2013-07-08T20:48:11.493Z">July 2013</div>
    <div class="title">Node Packaged Modules</div>
    <div class="teaser">Bringing NPM modules to the web</div>
  </div>
</a>

<a class="load-document" href="kindleberry-wireless.html">
  <div class="document" id="kindleberry-wireless">
    <div class="published" data-published="2013-03-24T20:48:11.493Z">March 2013</div>
    <div class="title">Kindleberry Wireless</div>
    <div class="teaser">A Portable Outdoor Hackstation</div>
  </div>
</a>

<a class="load-document" href="bringing-minecraft-style-games-to-the-open-web.html">
  <div class="document" id="bringing-minecraft-style-games-to-the-open-web">
    <div class="published" data-published="2013-01-25T20:48:11.493Z">January 2013</div>
    <div class="title">Bringing Minecraft-style games to the Open Web</div>
    <div class="teaser">A status report from the one month old voxel.js project</div>
  </div>
</a>

<a class="load-document" href="a-proposal-for-streaming-xhr.html">
  <div class="document" id="a-proposal-for-streaming-xhr">
    <div class="published" data-published="2012-11-20T20:48:11.493Z">November 2012</div>
    <div class="title">A Proposal For Streaming XHR</div>
    <div class="teaser">XHR2 isn't stream friendly. Lets explore why and propose a solution!</div>
  </div>
</a>

<a class="load-document" href="scraping-with-node.html">
  <div class="document" id="scraping-with-node">
    <div class="published" data-published="2012-10-24T20:48:11.493Z">October 2012</div>
    <div class="title">Scraping With Node</div>
    <div class="teaser">Useful modules and a tutorial on how to parse HTML with node.js</div>
  </div>
</a>

<a class="load-document" href="building-webview-applications.html">
  <div class="document" id="building-webview-applications">
    <div class="published" data-published="2012-10-15T20:48:11.493Z">October 2012</div>
    <div class="title">Building WebView Applications</div>
    <div class="teaser">Things I learned while building @gather</div>
  </div>
</a>

<a class="load-document" href="fast-webview-applications.html">
  <div class="document" id="fast-webview-applications">
    <div class="published" data-published="2012-05-31T20:48:11.493Z">May 2012</div>
    <div class="title">Fast WebView Applications</div>
    <div class="teaser">How to make web apps feel fast and responsive</div>
  </div>
</a>

<a class="load-document" href="node-streams.html">
  <div class="document" id="node-streams">
    <div class="published" data-published="2012-04-17T23:52:20.241Z">April 2012</div>
    <div class="title">Node Streams: How do they work?</div>
    <div class="teaser">Description of and notes on the node.js Stream API</div>
  </div>
</a>

<a class="load-document" href="gut-hosted-open-data-filets.html">
  <div class="document" id="gut-hosted-open-data-filets">
    <div class="published" data-published="2011-12-02T20:36:31.424Z">December 2011</div>
    <div class="title">Gut: Hosted Open Data Filet Knives</div>
    <div class="teaser">HTTP Unix pipes for Open Data</div>
  </div>
</a>

<a class="load-document" href="little-coders.html">
  <div class="document" id="little-coders">
    <div class="published" data-published="2011-07-17T02:56:48.555Z">July 2011</div>
    <div class="title">Little Coders</div>
    <div class="teaser">Elementary school programming</div>
  </div>
</a></div>
      </div>
      <div id="document"><div id="header"><h1 class="title">node-repl</h1></div>

<p>An interactive console for node</p>
<p>You can <a href="https://www.npmjs.com/package/node-repl#installation">install node-repl with npm</a>.</p>
<p>Recently I was asked if there was an equivalent of the <a href="http://en.wikipedia.org/wiki/Interactive_Ruby_Shell">Interactive Ruby Shell (IRB)</a> for node. IRB is great because it lets you quickly poke around in your program while it is running without having to set up breakpoints or print messages out to the console.</p>
<p>Node ships with a <a href="http://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop">repl</a> that you can run by simply typing <code>node</code>, and you can run a program by running <code>node program.js</code>, but you cannot both run a program <em>and</em> open a repl at the same time.</p>
<p>To solve this, with the help of my friends <a href="http://github.com/mafintosh">Mathias</a> and <a href="https://github.com/chrisdickinson">Chris</a> I whipped up a command-line module called <a href="http://npmjs.org/node-repl"><code>node-repl</code></a>.</p>
<p>Here&#39;s how to use it:</p>
<p><img src="media/node-repl.png" alt="node-repl"></p>
<p>When you run a program with <code>node-repl program.js</code>, it both spawns your program but also opens a repl. The useful part is that the repl is executing code in the same JavaScript scope that your program is running in.</p>
<h2 id="how-it-works">How it works</h2>
<p>The functionality offered by <code>node-repl</code> seems simple at first, but underneath the hood it is doing a few tricky things: injecting the repl code, intercepting node&#39;s <code>require</code> and patching in <code>eval</code> from your program&#39;s scope into the repl.</p>
<h3 id="injecting-the-repl-code">Injecting the repl code</h3>
<p>Node has a <code>repl</code> module <a href="https://iojs.org/api/repl.html">in the core library</a> that makes it easy to implement a fully featured repl. By default the repl executes code in it&#39;s own scope, but in order to get the desired IRB-style functionality (e.g. where <code>pizza</code> is available to the repl as in the above example) we want the repl to execute in the same scope as the program.</p>
<p>The <a href="https://github.com/maxogden/node-repl/blob/master/repl.js">repl code itself</a> that <code>node-repl</code> injects is relatively simple:</p>
<pre><code class="lang-js">;(function() {
  var repl = require(&#39;repl&#39;)
  var os = require(&#39;os&#39;)
  var empty = &#39;(&#39; + os.EOL + &#39;)&#39;
  repl.start({
    input: process.stdin,
    output: process.stdout,
    eval: function(cmd, context, filename, callback) {
      if (cmd === empty) return callback()
      var result = eval(cmd)
      callback(null, result)
    }
  })
})();
</code></pre>
<p>The whole thing is wrapped in an <a href="http://en.wikipedia.org/wiki/Immediately-invoked_function_expression">IIFE</a> to avoid altering any external state in the users program, since <a href="https://github.com/maxogden/node-repl/blob/master/bin.js#L19">this code is concatenated</a> onto the end of the program. I very rarely use IIFEs any more because node&#39;s module system handles isolating files for you automatically (and if you use browserify you can use node&#39;s module system for client side code), but this case is an exception.</p>
<p>The code <code>var empty = &#39;(&#39; + os.EOL + &#39;)&#39;</code> is specific to how node&#39;s repl works. When you hit <code>&lt;return&gt;</code> in node&#39;s it takes whatever you typed and wrapps it in parentheses. For example, if you enter <code>var x = 1</code> and hit return you will end up with <code>(var x = 1\n)</code> on OSX/Linux or <code>(var x = 1\r\n)</code> on Windows. The code <code>require(&#39;os&#39;).EOL</code> gets the correct line ending for the users current OS. Also (warning: this is just a parlour trick) try going into the default node repl and typing <code>console.log)(42</code>. Even though you didn&#39;t type valid JS code, it ends up working because it gets turned into <code>(console.log)(42)\n</code> by the repl.</p>
<h3 id="a-quick-primer-on-scopes-in-node-modules">A quick primer on scopes in node modules</h3>
<p>When you run a program with node, e.g. <code>node hello.js</code> or <code>require(&#39;hello.js&#39;)</code>, node takes the contents of <code>hello.js</code> and wraps them in a function like this:</p>
<pre><code class="lang-js">(function (exports, require, module, __filename, __dirname) {
  var pizza = 1
});
</code></pre>
<p>Wrapping your code in a a function like this causes a new scope to be created for your code to run in. You could have two different modules that both set <code>var pizza</code> to different values, and because of the way that JavaScript&#39;s function scope works they can both exist in their own scopes without conflicting. This property of JavaScript is what allows node&#39;s <a href="http://maxogden.com/nested-dependencies.html">nested dependency</a> system to work and is extremely simple and powerful.</p>
<p>The problem with this for us is that your code is running in it&#39;s own scope, and <code>node-repl</code> needs access to it! This is why we &quot;inject&quot; (in this case by concatenating) our repl code into your code before it gets required.</p>
<h3 id="intercepting-node-s-require-call">Intercepting node&#39;s require call</h3>
<p>Node has a somewhat obscure API called <code>require.extensions</code> that lets you change what happens when files of a certain file extension are required. For <code>node-repl</code> we use this to rewrite the users program before it gets executed.</p>
<p>The following code is from <a href="https://github.com/maxogden/node-repl/blob/master/bin.js">https://github.com/maxogden/node-repl/blob/master/bin.js</a></p>
<pre><code class="lang-js">var original = require.extensions[&#39;.js&#39;]
require.extensions[&#39;.js&#39;] = function(module, filename) {
  if (filename !== file) return original(module, filename)
  var content = fs.readFileSync(filename).toString()
  module._compile(stripBOM(content + replCode), filename)
}

require(file)
</code></pre>
<p>First we store the original <code>.js</code> require function, so that we can call it for files other than our program. Then we define our own custom <code>require.extension</code> that emulates what the default <code>.js</code> require code does, but does <code>content + replCode</code> first, which &#39;injects&#39; our repl into the users program code. We reverse engineered the default <code>.js</code> functionality by looking at the output of <code>console.log(require.extensions[&#39;.js&#39;])</code>.</p>
<p>Finally, we <code>require(file)</code> which triggers the extension we just defined with the users program. This was confusing to me at first because the users program may not have <code>module.exports</code> in it, and it seemed unintuitive to me to <code>require</code> something when I really just wanted to execute it, but this is in fact a valid way to simply run code. <code>module.exports</code> defaults to an empty object (<code>{}</code>), meaning you can simply use <code>require</code> to run a JS program in it&#39;s own scope.</p>
<h3 id="patching-in-eval-">Patching in <code>eval</code></h3>
<p>The node repl <a href="https://iojs.org/api/repl.html#repl_repl_start_options">supports passing in a custom <code>eval</code> function</a>, which is how we are able to swap out it&#39;s default eval with the eval from the program scope.</p>
<p>After being wrapped by <code>require</code> and having our repl injected the code looks like this:</p>
<pre><code class="lang-js">(function (exports, require, module, __filename, __dirname) {
  var pizza = 1
  ;(function() {
    var repl = require(&#39;repl&#39;)
    var os = require(&#39;os&#39;)
    var empty = &#39;(&#39; + os.EOL + &#39;)&#39;
    repl.start({
      input: process.stdin,
      output: process.stdout,
      eval: function(cmd, context, filename, callback) {
        if (cmd === empty) return callback()
        var result = eval(cmd)
        callback(null, result)
      }
    })
  })();
});
</code></pre>
<p>The trick here is that <code>eval</code> above is the eval from the same scope as what the program is running in, which gives it access to local variables like <code>pizza</code>.</p>
<p>Happy hacking!</p>
</div>
    </div>
  </div>  
  
  <script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24933665-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

  </script>
</body> 
</html>
